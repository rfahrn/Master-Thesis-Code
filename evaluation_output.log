
╔════════════════════════════════════════════════════════════════════════════╗
║                                                                            ║
║         REWARD FUNCTION EVALUATION FOR RADIOLOGY GROUNDING/DETECTION       ║
║                                                                            ║
║         Master Thesis: Optimal Reward Functions for GRPO-based VLM         ║
║                                                                            ║
╚════════════════════════════════════════════════════════════════════════════╝
    
================================================================================
REWARD FUNCTION EVALUATION FOR RADIOLOGY GROUNDING
================================================================================

Evaluating 4 reward functions
across 15 test scenarios


[1/15] Perfect_Single_Box
    Description: Perfect match for single finding
    GT boxes: 1, Pred boxes: 1
    R3_FBeta_MeanIoU: 1.0000
    R4_Smooth_Gradients: 1.0000
    R5_Soft_Partial_Credit: 1.0000
    R6_F1_Weighted_IoU: 1.0000

[2/15] Perfect_Multi_Box
    Description: Perfect match for 3 findings
    GT boxes: 3, Pred boxes: 3
    R3_FBeta_MeanIoU: 1.0000
    R4_Smooth_Gradients: 1.0000
    R5_Soft_Partial_Credit: 1.0000
    R6_F1_Weighted_IoU: 1.0000

[3/15] High_Overlap_Single
    Description: Good but not perfect localization (IoU≈0.8)
    GT boxes: 1, Pred boxes: 1
    R3_FBeta_MeanIoU: 0.8100
    R4_Smooth_Gradients: 0.8093
    R5_Soft_Partial_Credit: 0.8100
    R6_F1_Weighted_IoU: 0.8100

[4/15] Moderate_Overlap
    Description: Acceptable localization (IoU≈0.6)
    GT boxes: 1, Pred boxes: 1
    R3_FBeta_MeanIoU: 0.6400
    R4_Smooth_Gradients: 0.6475
    R5_Soft_Partial_Credit: 0.6400
    R6_F1_Weighted_IoU: 0.6400

[5/15] Low_Overlap
    Description: Poor localization (IoU≈0.3)
    GT boxes: 1, Pred boxes: 1
    R3_FBeta_MeanIoU: 0.0000
    R4_Smooth_Gradients: 0.0000
    R5_Soft_Partial_Credit: 0.0000
    R6_F1_Weighted_IoU: 0.0000

[6/15] Barely_Overlap
    Description: Barely overlapping (IoU≈0.15)
    GT boxes: 1, Pred boxes: 1
    R3_FBeta_MeanIoU: 0.0000
    R4_Smooth_Gradients: 0.0000
    R5_Soft_Partial_Credit: 0.0000
    R6_F1_Weighted_IoU: 0.0000

[7/15] False_Positive_Single
    Description: Model hallucinates finding
    GT boxes: 0, Pred boxes: 1
    R3_FBeta_MeanIoU: 0.0000
    R4_Smooth_Gradients: 0.0000
    R5_Soft_Partial_Credit: 0.0000
    R6_F1_Weighted_IoU: 0.0000

[8/15] False_Negative_Single
    Description: Model misses finding
    GT boxes: 1, Pred boxes: 0
    R3_FBeta_MeanIoU: 0.0000
    R4_Smooth_Gradients: 0.0000
    R5_Soft_Partial_Credit: 0.0000
    R6_F1_Weighted_IoU: 0.0000

[9/15] True_Negative
    Description: Correctly no boxes when no findings
    GT boxes: 0, Pred boxes: 0
    R3_FBeta_MeanIoU: 0.2000
    R4_Smooth_Gradients: 0.2000
    R5_Soft_Partial_Credit: 0.2000
    R6_F1_Weighted_IoU: 0.2000

[10/15] Multi_Box_Partial_Recall
    Description: 2/3 findings detected (missed one)
    GT boxes: 3, Pred boxes: 2
    R3_FBeta_MeanIoU: 0.8000
    R4_Smooth_Gradients: 0.7429
    R5_Soft_Partial_Credit: 0.8000
    R6_F1_Weighted_IoU: 0.8000

[11/15] Multi_Box_Imprecise
    Description: All 3 found but varying IoU (1.0, 0.7, 0.4)
    GT boxes: 3, Pred boxes: 3
    R3_FBeta_MeanIoU: 0.8167
    R4_Smooth_Gradients: 0.8189
    R5_Soft_Partial_Credit: 0.8167
    R6_F1_Weighted_IoU: 0.8167

[12/15] Multi_Box_Extra_FP
    Description: 2 correct + 1 hallucinated
    GT boxes: 2, Pred boxes: 3
    R3_FBeta_MeanIoU: 0.8000
    R4_Smooth_Gradients: 0.8667
    R5_Soft_Partial_Credit: 0.8000
    R6_F1_Weighted_IoU: 0.8000

[13/15] Complex_Multi_Box
    Description: 5 GT boxes, 4 predictions with varying IoU
    GT boxes: 5, Pred boxes: 4
    R3_FBeta_MeanIoU: 0.5650
    R4_Smooth_Gradients: 0.5456
    R5_Soft_Partial_Credit: 0.6688
    R6_F1_Weighted_IoU: 0.5650

[14/15] Many_False_Positives
    Description: 1 GT box but model predicts 5
    GT boxes: 1, Pred boxes: 5
    R3_FBeta_MeanIoU: 0.3333
    R4_Smooth_Gradients: 0.4483
    R5_Soft_Partial_Credit: 0.3333
    R6_F1_Weighted_IoU: 0.3333

[15/15] Many_False_Negatives
    Description: 5 GT boxes but model predicts only 1
    GT boxes: 5, Pred boxes: 1
    R3_FBeta_MeanIoU: 0.3333
    R4_Smooth_Gradients: 0.2653
    R5_Soft_Partial_Credit: 0.3333
    R6_F1_Weighted_IoU: 0.3333

================================================================================
GENERATING PLOTS
================================================================================
  ✓ Saved: 01_reward_distributions.png
  ✓ Saved: 02_scenario_comparison.png
  ✓ Saved: 03_reward_heatmap.png
  ✓ Saved: 04_statistical_comparison.png
  ✓ Saved: 05_gradient_analysis.png

All plots saved to: reward_evaluation_results/

================================================================================
SUMMARY REPORT
================================================================================

R3_FBeta_MeanIoU
--------------------------------------------------------------------------------
  Mean Reward:        0.4866
  Std Dev:            0.3691
  Median:             0.5650
  Range:            [0.0000, 1.0000]
  Q25-Q75:          [0.1000, 0.8050]

  Scenario Breakdown:
    complex_multi       : mean= 0.5650, std= 0.0000, n=1
    false_negative      : mean= 0.0000, std= 0.0000, n=1
    false_positive      : mean= 0.0000, std= 0.0000, n=1
    many_fn             : mean= 0.3333, std= 0.0000, n=1
    many_fp             : mean= 0.3333, std= 0.0000, n=1
    multi_box_fp        : mean= 0.8000, std= 0.0000, n=1
    multi_box_partial   : mean= 0.8000, std= 0.0000, n=1
    multi_box_varying   : mean= 0.8167, std= 0.0000, n=1
    partial             : mean= 0.3625, std= 0.3674, n=4
    perfect             : mean= 1.0000, std= 0.0000, n=2
    true_negative       : mean= 0.2000, std= 0.0000, n=1

R4_Smooth_Gradients
--------------------------------------------------------------------------------
  Mean Reward:        0.4896
  Std Dev:            0.3707
  Median:             0.5456
  Range:            [0.0000, 1.0000]
  Q25-Q75:          [0.1000, 0.8141]

  Scenario Breakdown:
    complex_multi       : mean= 0.5456, std= 0.0000, n=1
    false_negative      : mean= 0.0000, std= 0.0000, n=1
    false_positive      : mean= 0.0000, std= 0.0000, n=1
    many_fn             : mean= 0.2653, std= 0.0000, n=1
    many_fp             : mean= 0.4483, std= 0.0000, n=1
    multi_box_fp        : mean= 0.8667, std= 0.0000, n=1
    multi_box_partial   : mean= 0.7429, std= 0.0000, n=1
    multi_box_varying   : mean= 0.8189, std= 0.0000, n=1
    partial             : mean= 0.3642, std= 0.3687, n=4
    perfect             : mean= 1.0000, std= 0.0000, n=2
    true_negative       : mean= 0.2000, std= 0.0000, n=1

R5_Soft_Partial_Credit
--------------------------------------------------------------------------------
  Mean Reward:        0.4935
  Std Dev:            0.3714
  Median:             0.6400
  Range:            [0.0000, 1.0000]
  Q25-Q75:          [0.1000, 0.8050]

  Scenario Breakdown:
    complex_multi       : mean= 0.6688, std= 0.0000, n=1
    false_negative      : mean= 0.0000, std= 0.0000, n=1
    false_positive      : mean= 0.0000, std= 0.0000, n=1
    many_fn             : mean= 0.3333, std= 0.0000, n=1
    many_fp             : mean= 0.3333, std= 0.0000, n=1
    multi_box_fp        : mean= 0.8000, std= 0.0000, n=1
    multi_box_partial   : mean= 0.8000, std= 0.0000, n=1
    multi_box_varying   : mean= 0.8167, std= 0.0000, n=1
    partial             : mean= 0.3625, std= 0.3674, n=4
    perfect             : mean= 1.0000, std= 0.0000, n=2
    true_negative       : mean= 0.2000, std= 0.0000, n=1

R6_F1_Weighted_IoU
--------------------------------------------------------------------------------
  Mean Reward:        0.4866
  Std Dev:            0.3691
  Median:             0.5650
  Range:            [0.0000, 1.0000]
  Q25-Q75:          [0.1000, 0.8050]

  Scenario Breakdown:
    complex_multi       : mean= 0.5650, std= 0.0000, n=1
    false_negative      : mean= 0.0000, std= 0.0000, n=1
    false_positive      : mean= 0.0000, std= 0.0000, n=1
    many_fn             : mean= 0.3333, std= 0.0000, n=1
    many_fp             : mean= 0.3333, std= 0.0000, n=1
    multi_box_fp        : mean= 0.8000, std= 0.0000, n=1
    multi_box_partial   : mean= 0.8000, std= 0.0000, n=1
    multi_box_varying   : mean= 0.8167, std= 0.0000, n=1
    partial             : mean= 0.3625, std= 0.3674, n=4
    perfect             : mean= 1.0000, std= 0.0000, n=2
    true_negative       : mean= 0.2000, std= 0.0000, n=1

✓ Saved detailed results to: reward_evaluation_results/evaluation_results.json

================================================================================
RECOMMENDATIONS FOR GRPO TRAINING
================================================================================

1. RANKING BY MEAN REWARD:
   1. R5_Soft_Partial_Credit         (mean=0.4935)
   2. R4_Smooth_Gradients            (mean=0.4896)
   3. R3_FBeta_MeanIoU               (mean=0.4866)
   4. R6_F1_Weighted_IoU             (mean=0.4866)

2. RANKING BY STABILITY (lowest std):
   1. R3_FBeta_MeanIoU               (std=0.3691)
   2. R6_F1_Weighted_IoU             (std=0.3691)
   3. R4_Smooth_Gradients            (std=0.3707)
   4. R5_Soft_Partial_Credit         (std=0.3714)

3. RANKING BY DYNAMIC RANGE:
   1. R3_FBeta_MeanIoU               (range=1.0000)
   2. R5_Soft_Partial_Credit         (range=1.0000)
   3. R6_F1_Weighted_IoU             (range=1.0000)
   4. R4_Smooth_Gradients            (range=1.0000)

--------------------------------------------------------------------------------
KEY CONSIDERATIONS FOR GRPO:
--------------------------------------------------------------------------------

For GRPO (Group Relative Policy Optimization), consider:

1. **Dense Rewards**: Functions that provide smooth gradients across IoU levels
   - Avoid sparse binary rewards (good: R3, R4, R5, R6)

2. **Balanced Precision-Recall**: Critical for multi-box detection
   - Look for balanced performance across scenario types

3. **Partial Credit**: Enables learning from imperfect predictions
   - R5 explicitly provides partial credit for mediocre boxes

4. **Gradient Smoothness**: Smooth reward curves enable stable policy updates
   - R4 uses spline transformation for smoother gradients

5. **Multi-Box Scaling**: Should scale appropriately with number of boxes
   - Check multi_box scenarios in heatmap

RECOMMENDED TOP 3 FOR RADIOLOGY GROUNDING:

Based on the evaluation, consider these priorities:
   a) If gradient smoothness is critical → R4 (Smooth Gradients)
   b) If partial credit for learning → R5 (Soft Partial Credit)
   c) If balanced F1 approach → R6 (F1-Weighted IoU)
   d) If proven baseline → R3 (F-beta × mean IoU)

Examine the plots and scenario-specific performance to make final decision.
        

================================================================================
EVALUATION COMPLETE!
================================================================================

Check the 'reward_evaluation_results/' directory for:
  - 5 comprehensive plots (PNG)
  - Detailed results (JSON)
  - This terminal output for analysis


